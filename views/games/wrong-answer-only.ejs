<%- include('../partials/header') %>

<div class="container py-4">
    <div class="game-header text-center mb-4">
        <h1><i class="fas fa-times-circle me-2 text-warning"></i>Wrong Answer Only</h1>
        <p class="lead">Get points for wrong answers! Avoid being correct!</p>
        
        <!-- Difficulty Filter -->
        <div class="mb-3">
            <h6 class="text-muted mb-2">Difficulty Level:</h6>
            <div class="btn-group" role="group" aria-label="Difficulty filter">
                <input type="radio" class="btn-check" name="difficulty" id="all" value="all" <%= (!difficulty || difficulty === 'all') ? 'checked' : '' %>>
                <label class="btn btn-outline-secondary btn-sm" for="all">All Levels</label>
                
                <input type="radio" class="btn-check" name="difficulty" id="easy" value="easy" <%= (difficulty === 'easy') ? 'checked' : '' %>>
                <label class="btn btn-outline-success btn-sm" for="easy">Easy</label>
                
                <input type="radio" class="btn-check" name="difficulty" id="medium" value="medium" <%= (difficulty === 'medium') ? 'checked' : '' %>>
                <label class="btn btn-outline-warning btn-sm" for="medium">Medium</label>
                
                <input type="radio" class="btn-check" name="difficulty" id="hard" value="hard" <%= (difficulty === 'hard') ? 'checked' : '' %>>
                <label class="btn btn-outline-danger btn-sm" for="hard">Hard</label>
            </div>
        </div>
        
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Game Rule:</strong> You get points for WRONG answers. Getting it right gives you no points!
        </div>
    </div>

    <!-- Timer Info -->
    <div class="row mb-4">
        <div class="col-md-4 mx-auto">
            <div class="card bg-success text-white text-center">
                <div class="card-body">
                    <h4 id="timer">2.5</h4>
                    <p class="mb-0">Seconds Remaining</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Area -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-times-circle me-2"></i>
                        Current Challenge
                        <span class="badge bg-dark text-light ms-2"><%= riddle.category %></span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="riddleCard">
                        <!-- Display image if available, otherwise show text question -->
                        <% if (riddle.imageUrl) { %>
                            <div class="text-center mb-4">
                                <img src="<%= riddle.imageUrl %>" alt="Riddle image" class="img-fluid rounded shadow" style="max-width: 100%; max-height: 400px;">
                            </div>
                            <h4 class="card-title text-center mb-4" id="riddleQuestion">
                                <%= riddle.question || 'What is shown in this image?' %>
                            </h4>
                        <% } else { %>
                            <h4 class="card-title mb-4" id="riddleQuestion"><%= riddle.question %></h4>
                        <% } %>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Remember:</strong> <% if (riddle.imageUrl) { %>Look at the image and try to think of creative wrong answers!<% } else { %>Think of creative wrong answers for this riddle!<% } %>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="button" class="btn btn-warning btn-lg me-md-2" id="nextRiddleBtn">
                                <i class="fas fa-forward me-2"></i>Next Challenge
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" id="showAnswerBtn">
                                <i class="fas fa-eye me-2"></i>Show Answer
                            </button>
                        </div>
                    </div>

                    <!-- Answer Display Area -->
                    <div id="answerArea" class="mt-4 text-center" style="display: none;">
                        <div class="alert alert-success">
                            <h3><i class="fas fa-lightbulb me-2"></i>The Correct Answer Is:</h3>
                            <h1 id="correctAnswer" style="font-size: 2.5rem; font-weight: bold; text-transform: uppercase; color: #155724; margin: 20px 0;">
                                <%= riddle && riddle.answer ? riddle.answer.toUpperCase() : 'NO ANSWER PROVIDED' %>
                            </h1>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg" id="continueBtn">
                            <i class="fas fa-arrow-right me-2"></i>Continue to Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Strategy Tips -->
            <div class="card mt-3 border-warning">
                <div class="card-header bg-light">
                    <h6><i class="fas fa-lightbulb me-2 text-warning"></i>Strategy Tips</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li><i class="fas fa-star text-warning me-2"></i>Be creative with your wrong answers</li>
                        <li><i class="fas fa-star text-warning me-2"></i>Think of funny or unexpected responses</li>
                        <li><i class="fas fa-star text-warning me-2"></i>Avoid obvious correct answers</li>
                        <li><i class="fas fa-star text-warning me-2"></i>Have fun and don't overthink it!</li>
                    </ul>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="card mt-3">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-outline-danger me-2" id="resetGameBtn">
                        <i class="fas fa-redo me-2"></i>Reset Game
                    </button>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-home me-2"></i>Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let timerInterval = null;
let timeRemaining = 2.5;

// Timer functions
function startTimer() {
    timeRemaining = 2.5;
    updateTimerDisplay();
    
    timerInterval = setInterval(() => {
        timeRemaining = Math.max(0, timeRemaining - 0.1);
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            autoShowAnswer();
        }
    }, 100); // Update every 100ms for smoother countdown
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timer');
    timerElement.textContent = timeRemaining.toFixed(1);
    
    // Change color based on time remaining
    const timerCard = timerElement.closest('.card');
    if (timeRemaining <= 1) {
        timerCard.className = 'card bg-danger text-white text-center';
    } else if (timeRemaining <= 2) {
        timerCard.className = 'card bg-warning text-white text-center';
    } else {
        timerCard.className = 'card bg-success text-white text-center';
    }
}

function autoShowAnswer() {
    const riddleCard = document.getElementById('riddleCard');
    const answerArea = document.getElementById('answerArea');
    
    if (riddleCard.style.display !== 'none') {
        riddleCard.style.display = 'none';
        answerArea.style.display = 'block';
    }
}

// Start timer when page loads
document.addEventListener('DOMContentLoaded', function() {
    startTimer();
});

// Show Answer Button
document.getElementById('showAnswerBtn').addEventListener('click', function() {
    stopTimer();
    const riddleCard = document.getElementById('riddleCard');
    const answerArea = document.getElementById('answerArea');
    
    riddleCard.style.display = 'none';
    answerArea.style.display = 'block';
});

// Next Challenge and Continue buttons
document.getElementById('nextRiddleBtn').addEventListener('click', loadNewRiddle);
document.getElementById('continueBtn').addEventListener('click', loadNewRiddle);

// Difficulty filter handling
document.addEventListener('DOMContentLoaded', function() {
    const difficultyRadios = document.querySelectorAll('input[name="difficulty"]');
    
    difficultyRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const selectedDifficulty = this.value;
            // Reload page with new difficulty
            const url = selectedDifficulty === 'all' ? '/games/wrong-answer-only' : `/games/wrong-answer-only?difficulty=${selectedDifficulty}`;
            window.location.href = url;
        });
    });
});

async function loadNewRiddle() {
    try {
        // Get current difficulty from session or use 'all' as default
        const difficulty = '<%= typeof difficulty !== "undefined" ? difficulty : "all" %>';
        const url = difficulty === 'all' ? '/games/new-riddle/wrong-answer-only' : `/games/new-riddle/wrong-answer-only?difficulty=${difficulty}`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            // Update riddle display based on whether it has an image
            const riddleQuestion = document.getElementById('riddleQuestion');
            const correctAnswerElement = document.getElementById('correctAnswer');
            
            if (result.riddle.imageUrl) {
                // Update for image riddle
                riddleQuestion.innerHTML = `
                    <div class="text-center mb-4">
                        <img src="${result.riddle.imageUrl}" alt="Riddle image" class="img-fluid rounded shadow" style="max-width: 100%; max-height: 400px;">
                    </div>
                    ${result.riddle.question || 'What is shown in this image?'}
                `;
                
                // Update the info alert
                const infoAlert = document.querySelector('.alert-info');
                infoAlert.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>Remember:</strong> Look at the image and try to think of creative wrong answers!';
            } else {
                // Update for text riddle
                riddleQuestion.textContent = result.riddle.question;
                
                // Update the info alert
                const infoAlert = document.querySelector('.alert-info');
                infoAlert.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>Remember:</strong> Think of creative wrong answers for this riddle!';
            }
            
            // Update the correct answer with safety check
            const answerText = result.riddle.answer && result.riddle.answer !== 'No answer provided' 
                ? result.riddle.answer.toUpperCase() 
                : 'NO ANSWER PROVIDED';
            correctAnswerElement.textContent = answerText;
            
            // Update category badge
            const header = document.querySelector('.card-header h5');
            header.innerHTML = `
                <i class="fas fa-times-circle me-2"></i>
                Current Challenge
                <span class="badge bg-dark text-light ms-2">${result.riddle.category}</span>
            `;
            
            // Reset UI
            document.getElementById('riddleCard').style.display = 'block';
            document.getElementById('answerArea').style.display = 'none';
            
            // Restart timer
            startTimer();
            
        } else {
            alert('Error loading new riddle: ' + result.message);
        }
    } catch (error) {
        alert('Error loading new riddle. Please refresh the page.');
    }
}

document.getElementById('resetGameBtn').addEventListener('click', function() {
    if (confirm('Are you sure you want to reset the session?')) {
        fetch('/games/reset/wrong-answer-only', { method: 'POST' })
            .then(() => location.reload());
    }
});
</script>

<%- include('../partials/footer') %>
